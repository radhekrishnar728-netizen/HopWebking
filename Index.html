<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HopWeb Ultimate Studio v2</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- 1. GLOBAL VARIABLES --- */
        :root {
            --primary: #2196f3;
            --bg: #f5f7fa;
            --surface: #ffffff;
            --text-main: #333;
            --text-sub: #888;
            --green: #4caf50;
            --orange: #ef6c00;
            --danger: #f44336;
            --border: #e0e0e0;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.06);
            --radius: 16px;
            --toolbar-bg: #222;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); height: 100vh; overflow: hidden; display: flex; flex-direction: column; color: var(--text-main); }
        input, textarea { user-select: text; }

        /* --- 2. UTILITY CLASSES --- */
        .hidden { display: none !important; }
        .view { width: 100%; height: 100%; position: absolute; background: var(--bg); display: flex; flex-direction: column; overflow-y: auto; transition: transform 0.25s cubic-bezier(0.4, 0.0, 0.2, 1); }
        
        /* Toast */
        .toast { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); 
            background: #222; color: white; padding: 12px 24px; border-radius: 50px; 
            font-size: 14px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 9999; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: 500; display: flex; align-items: center; gap: 8px;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* --- 3. HOME SCREEN --- */
        .home-header { padding: 40px 20px 25px; text-align: center; background: var(--surface); border-bottom: 1px solid var(--border); }
        .logo-area { font-size: 28px; font-weight: 700; color: var(--primary); display: flex; justify-content: center; gap: 12px; align-items: center; margin-bottom: 25px; }
        .logo-icon { width: 36px; height: 48px; background: var(--primary); border-radius: 8px; position: relative; }
        .logo-icon::after { content:''; width:12px; height:12px; background:white; position:absolute; bottom:-5px; right:-5px; border-radius:50%; }
        
        .home-actions { display: flex; justify-content: center; gap: 15px; }
        .pill-btn { 
            background: #f0f8ff; border: 1px solid #bbdefb; padding: 12px 24px; border-radius: 30px; 
            font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 8px; 
            cursor: pointer; transition: 0.1s;
        }
        .pill-btn:active { background: #e3f2fd; transform: scale(0.98); }
        .icon-btn { 
            width: 48px; height: 48px; border-radius: 50%; background: white; border: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: center; color: #555; cursor: pointer; 
        }
        .icon-btn:active { background: #f5f5f5; }

        .project-list { padding: 20px; flex: 1; overflow-y: auto; }
        .p-card { 
            background: var(--surface); padding: 16px; border-radius: var(--radius); display: flex; align-items: center; 
            gap: 15px; margin-bottom: 15px; box-shadow: var(--card-shadow); cursor: pointer; 
            position: relative; border: 1px solid transparent; transition: 0.1s;
        }
        .p-card:active { border-color: var(--primary); transform: scale(0.99); }
        .p-icon { width: 45px; height: 55px; background: var(--primary); border-radius: 8px; position: relative; flex-shrink: 0; }
        .p-icon::after { content:''; width:14px; height:14px; background:white; position:absolute; bottom:-5px; right:-5px; border-radius:50%; }
        .p-menu-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #999; padding: 12px; border-radius: 50%; z-index: 5; }
        .p-menu-btn:active { background: #f0f0f0; color: var(--primary); }

        .footer-nav { 
            padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; 
            border-top: 1px solid var(--border); background: var(--surface); 
        }
        .f-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #aaa; font-size: 11px; font-weight: 600; }
        .f-item.active { color: var(--primary); }

        /* --- 4. DASHBOARD --- */
        .dash-nav { 
            height: 60px; background: white; display: flex; align-items: center; 
            justify-content: space-between; padding: 0 15px; border-bottom: 1px solid var(--border); 
        }
        .dash-actions { padding: 20px 15px 15px; display: flex; gap: 15px; }
        .big-action { 
            flex: 1; padding: 18px; border-radius: 12px; color: white; display: flex; 
            align-items: center; justify-content: center; gap: 10px; font-weight: 600; font-size: 15px; 
            cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: 0.1s;
        }
        .big-action:active { transform: scale(0.98); opacity: 0.9; }
        
        .info-banner { 
            background: #e3f2fd; border: 1px solid #bbdefb; color: #1565c0; padding: 14px 15px; 
            margin: 0 15px 20px; border-radius: 10px; font-size: 13px; display: flex; 
            align-items: center; justify-content: space-between; 
        }
        
        .file-header { 
            padding: 0 15px; display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 10px; height: 40px; 
        }
        .file-tools { display: flex; align-items: center; gap: 20px; }
        .file-tools i { color: #444; cursor: pointer; }
        
        .search-container { 
            flex: 1; display: flex; align-items: center; background: white; border: 1px solid #ddd; 
            border-radius: 8px; padding: 0 10px; margin-right: 10px; height: 42px; 
        }
        .search-input { border: none; flex: 1; margin-left: 8px; font-size: 15px; color: #333; height: 100%; }

        /* --- 5. FILES --- */
        .file-item { 
            background: transparent; padding: 12px 15px; margin: 0; border-bottom: 1px solid #f0f0f0; 
            display: flex; align-items: center; justify-content: space-between; cursor: pointer; 
        }
        .file-item:active { background: #f9f9f9; }
        .file-left { display: flex; align-items: center; gap: 15px; flex: 1; overflow: hidden; }
        .file-icon-box { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .file-info { display: flex; flex-direction: column; gap: 3px; }
        .file-name { font-size: 15px; color: #222; font-weight: 500; }
        .file-date { font-size: 11px; color: var(--text-sub); }
        .file-menu { color: #ccc; padding: 8px; border-radius: 50%; }
        .file-item-back { background: #fff3e0; border-bottom: 1px solid #ffe0b2; }
        .file-item-back .file-name { color: #ef6c00; font-weight: bold; }

        /* --- 6. EDITOR & TOOLBAR --- */
        #view-editor { background: #272822; }
        .editor-top { 
            height: 55px; background: #1e1e1e; display: flex; align-items: center; 
            justify-content: space-between; padding: 0 10px; border-bottom: 1px solid #333; color: white; 
        }
        .tabs-bar { display: flex; overflow-x: auto; background: #1e1e1e; height: 35px; align-items: flex-end; }
        .tab { 
            padding: 8px 20px; font-size: 12px; color: #888; border-right: 1px solid #333; 
            background: #252526; cursor: pointer; border-top: 2px solid transparent; white-space: nowrap; 
        }
        .tab.active { background: #272822; color: #fff; border-top: 2px solid var(--primary); }
        #ace-editor { flex: 1; font-size: 14px; }
        #image-previewer { flex: 1; display: flex; align-items: center; justify-content: center; background: #333; overflow: hidden; }
        #image-previewer img { max-width: 90%; max-height: 90%; border: 2px solid #555; }
        
        /* BLACK KEYBOARD TOOLBAR */
        .editor-toolbar {
            background: var(--toolbar-bg);
            border-top: 1px solid #444;
            padding: 6px 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 15;
            flex-shrink: 0;
        }
        .toolbar-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 5px;
        }
        .t-btn {
            color: #ddd;
            font-size: 12px;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }
        .t-btn:active { background: rgba(255,255,255,0.15); color: white; }
        
        .fab-run { 
            position: fixed; bottom: 130px; right: 20px; width: 60px; height: 60px; 
            background: var(--green); border-radius: 50%; color: white; display: flex; 
            align-items: center; justify-content: center; box-shadow: 0 6px 15px rgba(0,0,0,0.3); 
            z-index: 20; cursor: pointer; transition: 0.2s;
        }
        .fab-run:active { transform: scale(0.9); }

        /* --- 7. PREVIEW --- */
        #view-preview { background: white; z-index: 50; }
        .prev-nav { 
            height: 50px; background: #f5f5f5; display: flex; align-items: center; 
            justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #ddd; 
        }
        .console-drawer { 
            /* REMOVED: Old fake console drawer, using Eruda now */
            display: none;
        }

        /* --- 8. SETTINGS --- */
        .settings-content { padding: 20px; padding-bottom: 120px; background: #fff; }
        .settings-header { text-align: center; margin-bottom: 30px; }
        .settings-header h2 { font-weight: 400; font-size: 24px; margin-top: 10px; color: #333; }
        .set-card { background: #f5f5f5; border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .lbl-blue { color: var(--primary); font-size: 14px; margin-bottom: 8px; display: block; font-weight: 600; }
        .fin-line { 
            width: 100%; background: transparent; border: none; border-bottom: 1px solid #ccc; 
            padding: 8px 0; font-size: 16px; color: #333; margin-bottom: 20px; border-radius: 0; 
        }
        .fin-line:focus { border-bottom: 2px solid var(--primary); }
        .img-picker-box { width: 100%; display: flex; justify-content: center; padding: 10px 0; margin-bottom: 15px; }
        .img-slot { width: 70px; height: 90px; background: var(--primary); border-radius: 10px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .img-slot img { width: 100%; height: 100%; object-fit: cover; }
        .img-slot::after { content:'+'; color: var(--primary); position: absolute; bottom: -6px; right: -6px; background: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .opt-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #eee; }
        .opt-lbl { font-size: 16px; color: #444; }
        .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        .action-bar-float { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; display: flex; gap: 15px; z-index: 100; }
        .action-btn { flex: 1; height: 55px; border-radius: 30px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 15px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); cursor: pointer; gap: 10px; transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.96); }
        .btn-share { background: var(--orange); }
        .btn-build { background: var(--primary); }

        /* --- 9. MODALS --- */
        .modal-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); 
            display:flex; align-items:center; justify-content:center; z-index: 1000; 
            opacity: 0; pointer-events: none; transition: 0.2s; backdrop-filter: blur(4px); 
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-box { background: white; width: 85%; max-width: 350px; border-radius: 20px; padding: 24px; transform: scale(0.95); transition: 0.2s; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.25); }
        .modal-overlay.show .modal-box { transform: scale(1); }
        
        .menu-list { list-style: none; margin-top: 10px; }
        .menu-item { padding: 16px 12px; font-size: 16px; color: #333; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: background 0.1s; border-radius: 8px; }
        .menu-item:active { background: #f5f5f5; }

        /* Chips */
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .chip { padding: 8px 14px; border-radius: 20px; border: 1px solid #ddd; font-size: 13px; color: #666; cursor: pointer; transition: 0.2s; background: white; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Templates */
        .template-scroll { display: flex; overflow-x: auto; gap: 12px; padding-bottom: 10px; margin-bottom: 15px; -webkit-overflow-scrolling: touch; }
        .temp-card { min-width: 140px; height: 90px; background: #f5f5f5; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #666; border: 2px solid transparent; cursor: pointer; position: relative; flex-direction: column; gap: 5px; }
        .temp-card.selected { border-color: var(--primary); background: #e3f2fd; color: var(--primary); }

        .spinner { width: 32px; height: 32px; border: 4px solid #e0e0e0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #ace-editor { 
    flex: 1; 
    font-size: 14px; 
    touch-action: none; /* यह लाइन बहुत ज़रूरी है */
}

    </style>
</head>
<body>

    <div id="view-home" class="view">
        <div class="home-header">
            <div class="logo-area"><div class="logo-icon"></div> HopWeb Pro</div>
            <div class="home-actions">
                <div class="pill-btn" onclick="openModal('create-modal')"><i data-lucide="plus-circle" size="18"></i> Create Project</div>
                <div class="icon-btn" onclick="openModal('git-menu')"><i data-lucide="git-branch" size="20"></i></div>
            </div>
        </div>
        <div class="project-list" id="project-list-container"></div>
        <div class="footer-nav">
            <div class="f-item active"><i data-lucide="home" size="24"></i> Home</div>
            <div class="f-item"><i data-lucide="zap" size="24"></i> ideaSky</div>
        </div>
    </div>

    <div id="view-dashboard" class="view hidden">
        <div class="dash-nav">
            <i data-lucide="arrow-left" onclick="goView('view-home')"></i>
            <span id="dash-title" style="font-weight: 600; font-size: 18px;">Project</span>
            <i data-lucide="settings" onclick="goView('view-settings')"></i>
        </div>
        <div class="dash-actions">
            <div class="big-action" style="background: var(--green);" onclick="openModal('php-modal')">
                <i data-lucide="check-circle"></i> PHP Server
            </div>
            <div class="big-action" style="background: var(--orange);" onclick="goView('view-settings')">
                <i data-lucide="upload-cloud"></i> Publish
            </div>
        </div>
        <div class="info-banner">
            <span>Use database to improve project...</span>
            <i data-lucide="database" size="18"></i>
        </div>
        <div class="file-header">
            <div id="header-title-mode" style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                <span style="font-weight: bold; font-size: 20px;">Website</span>
                <div class="file-tools">
                    <i data-lucide="search" size="22" onclick="toggleSearch(true)"></i>
                    <i data-lucide="git-branch" size="22" onclick="openModal('import-menu')"></i>
                    <i data-lucide="plus" size="22" onclick="openModal('file-modal')"></i>
                </div>
            </div>
            <div id="header-search-mode" class="hidden" style="display:flex; width:100%; align-items:center;">
                <div class="search-container">
                    <i data-lucide="search" size="16" color="#999"></i>
                    <input type="text" class="search-input" id="search-inp" placeholder="Search files..." onkeyup="handleSearch()">
                </div>
                <i data-lucide="x" size="22" color="#555" onclick="toggleSearch(false)"></i>
            </div>
        </div>
        <div id="file-list-container"></div>
    </div>

    <div id="view-editor" class="view hidden">
        <div class="editor-top">
            <i data-lucide="arrow-left" onclick="closeEditor()"></i>
            <span id="editor-fname">index.html</span>
            <i data-lucide="save" onclick="saveFile()"></i>
        </div>
        <div class="tabs-bar" id="tabs-container"></div>
        <div id="ace-editor"></div>
        <div id="image-previewer" class="hidden"><img id="img-prev-tag" src=""></div>
        
        <div class="editor-toolbar">
            <div class="toolbar-row">
                <div class="t-btn" onclick="editor.selectAll()">CTRL</div>
                <div class="t-btn" onclick="editor.insert('\t')"><i data-lucide="arrow-right-to-line" size="16"></i></div>
                <div class="t-btn">SHFT</div>
                <div class="t-btn" onclick="editor.undo()"><i data-lucide="undo-2" size="16"></i></div>
                <div class="t-btn" onclick="editor.redo()"><i data-lucide="redo-2" size="16"></i></div>
                <div class="t-btn" onclick="editor.execCommand('find')"><i data-lucide="search" size="16"></i></div>
                <div class="t-btn" onclick="saveFile()"><i data-lucide="save" size="16"></i></div>
                <div class="t-btn" onclick="editor.blur()">ESC</div>
            </div>
            <div class="toolbar-row">
                <div class="t-btn" onclick="editor.navigateLeft()"><i data-lucide="chevron-left" size="20"></i></div>
                <div class="t-btn" onclick="editor.navigateRight()"><i data-lucide="chevron-right" size="20"></i></div>
                <div class="t-btn" onclick="editor.navigateUp()"><i data-lucide="chevron-up" size="20"></i></div>
                <div class="t-btn" onclick="editor.navigateDown()"><i data-lucide="chevron-down" size="20"></i></div>
                <div class="t-btn" onclick="editor.moveLinesUp()"><i data-lucide="arrow-up" size="14"></i>M</div>
                <div class="t-btn" onclick="editor.moveLinesDown()"><i data-lucide="arrow-down" size="14"></i>M</div>
                <div class="t-btn" onclick="editor.copyLinesUp()"><i data-lucide="copy" size="14"></i>↑</div>
                <div class="t-btn" onclick="editor.copyLinesDown()"><i data-lucide="copy" size="14"></i>↓</div>
            </div>
        </div>

        <div class="fab-run" onclick="runProject()">
            <i data-lucide="play" fill="white"></i>
        </div>
    </div>

    <div id="view-preview" class="view hidden">
        <div class="prev-nav">
            <span style="font-weight: bold;">Browser</span>
            <div style="display:flex; gap:15px; align-items:center;">
                <i data-lucide="refresh-ccw" onclick="runProject()" title="Refresh"></i>
                <i data-lucide="x" onclick="goView('view-editor')"></i>
            </div>
        </div>
        <iframe id="preview-frame" style="flex:1; border:none; background:white;"></iframe>
    </div>

    <div id="view-settings" class="view hidden">
        <div class="dash-nav">
            <i data-lucide="arrow-left" onclick="goView('view-dashboard')"></i>
            <span>App Configuration</span>
            <span></span>
        </div>
        <div class="settings-content">
            <div class="settings-header">
                <i data-lucide="smartphone" size="48" color="#4caf50"></i>
                <h2>Convert to Android Application</h2>
            </div>
            
            <div class="set-card">
                <label class="lbl-blue">Application Icon</label>
                <div class="img-picker-box">
                    <div class="img-slot" onclick="pickImage('icon')">
                        <img id="prev-icon" src="" style="display:none;">
                    </div>
                </div>
                <label class="lbl-blue">Application Name</label>
                <input type="text" class="fin-line" id="cfg-appname" value="MyWebApp">
                <label class="lbl-blue">Package Name</label>
                <input type="text" class="fin-line" id="cfg-pkg" value="com.mycompany.mywebapp">
                <label class="lbl-blue">Version Name</label>
                <input type="text" class="fin-line" id="cfg-vername" value="1.0.0">
                <label class="lbl-blue">Version Code</label>
                <input type="number" class="fin-line" id="cfg-vercode" value="1">
                
                <div class="opt-row">
                    <label class="lbl-blue" style="margin:0;">Title Bar Color</label>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="col-disp" style="font-family:monospace; color:#666;">#3F51B5</span>
                        <input type="color" id="cfg-color" value="#3F51B5" onchange="document.getElementById('col-disp').innerText=this.value" style="border:none; background:none; width:30px; height:30px; cursor:pointer;">
                    </div>
                </div>
            </div>

            <div class="set-card">
                <label class="lbl-blue">Screen Rotation Method</label>
                <select class="fin-line" id="cfg-rot">
                    <option value="auto">Auto Rotate</option>
                    <option value="portrait">Portrait</option>
                    <option value="landscape">Landscape</option>
                </select>
                <label class="lbl-blue">Homepage</label>
                <input type="text" class="fin-line" id="cfg-home" value="index.html">
            </div>

            <div class="set-card">
                <label class="lbl-blue">PHP Environment Options</label>
                <div class="opt-row">
                    <span class="opt-lbl">Carry PHP Environment</span>
                    <label class="switch">
                        <input type="checkbox" id="cfg-php">
                        <span class="slider"></span>
                    </label>
                </div>
                <label class="lbl-blue" style="margin-top:10px;">PHP Server Port</label>
                <input type="number" class="fin-line" id="cfg-port" value="57249">
            </div>

            <div class="set-card">
                <label class="lbl-blue">Image of Splash Page</label>
                <div class="img-picker-box">
                    <div class="img-slot" onclick="pickImage('splash')" style="background:#ddd;">
                        <img id="prev-splash" src="" style="display:none;">
                    </div>
                </div>
            </div>

            <div class="set-card">
                <label class="lbl-blue">More Options</label>
                <div id="toggles-container"></div>
            </div>
            
            <div class="action-bar-float">
                <div class="action-btn btn-share" onclick="triggerSystemShare()">
                    <i data-lucide="share-2" size="20"></i> Share Feature
                </div>
                <div class="action-btn btn-build" onclick="startBuild()">
                    <i data-lucide="check" size="20"></i> BUILD APK
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="project-options-modal">
        <div class="modal-box" style="padding:0; overflow:hidden;">
            <div style="padding: 20px; font-weight:700; font-size:18px; border-bottom:1px solid #eee;" id="menu-project-title">
                Project Name
            </div>
            <div class="menu-list">
                <div class="menu-item" onclick="triggerProjectRename()">
                    <i data-lucide="edit-3" size="18"></i> Rename Project
                </div>
                <div class="menu-item" onclick="triggerProjectExport()">
                    <i data-lucide="archive" size="18"></i> Export Website to ZIP
                </div>
                <div class="menu-item" style="color:var(--danger);" onclick="triggerProjectDelete()">
                    <i data-lucide="trash-2" size="18"></i> Delete Website
                </div>
            </div>
            <div style="text-align:right; padding:15px;">
                 <span style="color:var(--danger); font-weight:bold; cursor:pointer;" onclick="closeModal('project-options-modal')">CANCEL</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="php-modal">
        <div class="modal-box">
            <h3 style="margin-bottom:10px;">PHP Server Ready</h3>
            <p style="color:#666; font-size:14px; margin-bottom:15px; line-height:1.5;">
                This website has been deployed to local PHP Web Server.<br>
                <span style="color:var(--primary); font-weight:bold;">http://192.0.0.4:45267/</span>
            </p>
            <div style="background:#f5f5f5; padding:15px; border-radius:10px; margin-bottom:20px; display:flex; align-items:center; gap:12px;">
                <i id="db-icon" data-lucide="play-circle" size="36" color="#333" style="cursor:pointer;" onclick="initDatabase()"></i>
                <div>
                    <div id="db-title" style="font-weight:bold; font-size:14px; color:#333;">Initialize Database</div>
                    <div id="db-desc" style="font-size:12px; color:#666;">Setup MariaDB (MySQL) environment.</div>
                </div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:25px;">
                <span style="color:var(--primary); font-weight:bold; cursor:pointer;" onclick="closeModal('php-modal'); runProject()">VISIT</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="file-options-modal">
        <div class="modal-box" style="padding:0; overflow:hidden;">
            <div style="padding: 20px; font-weight:700; font-size:18px; border-bottom:1px solid #eee;" id="menu-file-title">
                filename.html
            </div>
            <div class="menu-list">
                <div class="menu-item" onclick="triggerFileRename()"><i data-lucide="edit-2" size="18"></i> Rename</div>
                <div class="menu-item" onclick="triggerFileDelete()"><i data-lucide="trash-2" size="18"></i> Delete</div>
                <div class="menu-item" onclick="showToast('Path Copied to Clipboard')"><i data-lucide="copy" size="18"></i> Copy Path</div>
            </div>
            <div style="text-align:right; padding:15px;">
                 <span style="color:var(--danger); font-weight:bold; cursor:pointer;" onclick="closeModal('file-options-modal')">CANCEL</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="create-modal">
        <div class="modal-box">
            <h3>Create Project</h3>
            <label class="lbl-blue">Project Name</label>
            <input type="text" class="fin-line" id="new-p-name" value="My Website">
            
            <label class="lbl-blue">Template</label>
            <div class="template-scroll">
                <div class="temp-card selected" onclick="selectTemplate(this, 'php')"><i data-lucide="file-code" size="24" style="margin-bottom:5px;"></i>PHP Template</div>
                <div class="temp-card" onclick="selectTemplate(this, 'html')"><i data-lucide="layout" size="24" style="margin-bottom:5px;"></i>HTML Template</div>
            </div>
            
            <div style="text-align:right; margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
                <span style="color:var(--primary); font-weight:bold; font-size:14px; cursor:pointer;">IMPORT</span>
                <span style="color:var(--primary); font-weight:bold; cursor:pointer;" onclick="createProject()">OK</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="file-modal">
        <div class="modal-box">
            <h3>Create</h3>
            <div class="chip-container">
                <div class="chip" onclick="setFileType('')">Folder</div>
                <div class="chip active" onclick="setFileType('.html')">HTML File</div>
                <div class="chip" onclick="setFileType('.css')">CSS File</div>
                <div class="chip" onclick="setFileType('.js')">JS File</div>
                <div class="chip" onclick="setFileType('.php')">PHP File</div>
            </div>
            <label class="lbl-blue">New File</label>
            <input type="text" class="fin-line" id="new-f-name" value=".html">
            <div style="text-align:right; margin-top:20px;">
                <span style="color:var(--primary); font-weight:bold; cursor:pointer;" onclick="createFile()">OK</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="git-menu">
        <div class="modal-box" style="padding:0; overflow:hidden;">
            <div style="padding: 20px; font-weight:700; font-size:18px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px;">
                <i data-lucide="git-branch" size="24"></i> Git Control
            </div>
            <div class="menu-list">
                <div class="menu-item" onclick="showToast('Cloned Repository')"><i data-lucide="download-cloud" size="18"></i> Clone Repository</div>
                <div class="menu-item" onclick="showToast('Changes Committed')"><i data-lucide="check-circle" size="18"></i> Commit Changes</div>
                <div class="menu-item" onclick="showToast('Pushed to Remote')"><i data-lucide="upload-cloud" size="18"></i> Push to Remote</div>
            </div>
            <div style="text-align:right; padding:15px;">
                 <span style="color:var(--danger); font-weight:bold; cursor:pointer;" onclick="closeModal('git-menu')">CLOSE</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-php-warn">
        <div class="modal-box">
            <h3>The App Will Carry PHP Environment</h3>
            <p style="color:#666; font-size:14px; line-height:1.5;">It will make the installer file about 37MB larger.</p>
            <div style="text-align:right; margin-top:20px; gap:20px; display:flex; justify-content:flex-end;">
                <span style="color:var(--primary); font-weight:bold; cursor:pointer;" onclick="closeModal('modal-php-warn')">CANCEL</span>
                <span style="color:var(--primary); font-weight:bold; cursor:pointer;" onclick="startRealProcess()">OK</span>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="modal-loading">
        <div class="modal-box" style="display:flex; align-items:center; gap:20px; padding:25px;">
            <div class="spinner"></div>
            <span style="color:#333; font-weight:500;">Building APK...</span>
        </div>
    </div>
    
    <div class="modal-overlay" id="modal-finish">
        <div class="modal-box">
            <h3>Conversion Finished</h3>
            <p style="color:#666; font-size:14px;">Now, you can share the installer to others.</p>
            <div style="text-align:right; margin-top:20px;">
                <span style="color:var(--primary); font-weight:bold; cursor:pointer;" onclick="triggerSystemShare()">OK</span>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="rename-modal">
        <div class="modal-box">
            <h3>Rename</h3>
            <input type="text" class="fin-line" id="rename-input" style="margin-top:15px;">
            <div style="text-align:right; margin-top:20px;">
                <span style="color:var(--danger); margin-right:15px; font-weight:bold; cursor:pointer;" onclick="closeModal('rename-modal')">CANCEL</span>
                <span style="color:var(--primary); font-weight:bold; cursor:pointer;" onclick="confirmRename()">RENAME</span>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="import-menu">
        <div class="modal-box" style="padding:0; overflow:hidden;">
            <div style="padding: 15px 20px; border-bottom:1px solid #eee; font-weight:bold; font-size:18px;">
                Import
            </div>
            <div class="menu-list">
                <div class="menu-item" onclick="triggerImport('media')">Import Media File</div>
                <div class="menu-item" onclick="triggerImport('file')">Import Other Type File</div>
            </div>
            <div style="text-align:right; padding:15px;">
                 <span style="color:var(--danger); font-weight:bold; cursor:pointer;" onclick="closeModal('import-menu')">CANCEL</span>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"><i data-lucide="info" size="16"></i> <span id="toast-msg">Message</span></div>

    <input type="file" id="import-media" hidden accept="image/*,video/*,audio/*" onchange="handleFileSelect(this, 'binary')">
    <input type="file" id="import-any" hidden onchange="handleFileSelect(this, 'auto')">
    <input type="file" id="sys-img-picker" hidden accept="image/*">

<script>
    // --- GLOBAL VARIABLES ---
    let projects = JSON.parse(localStorage.getItem('hop_projects')) || [];
    let curProj = null;
    let curFile = null;
    let editor = null;
    let currentSearch = ""; 
    let menuIdx = null; 
    let fileMenuName = null;
    let selectedTemplate = 'php'; 
    let currentPath = ""; 

    // --- INIT ---
    window.onload = () => {
        lucide.createIcons();
        initEditor();
        renderProjects();
        initSettingsUI();
    };
    // --- PINCH ZOOM VARIABLES ---
let initialPinchDistance = null;
let initialFontSize = 14;

function initEditor() { 
    // ... बाकी कोड
}

    function initEditor() {
        // Fix: Use CDN for base path so workers load correctly
        ace.config.set('basePath', 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/');
        
        editor = ace.edit("ace-editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/html");
        editor.setOptions({ 
            fontSize: "14pt", 
            wrap: true, 
            showPrintMargin: false,
            useWorker: false 
        });
    }
       // --- PINCH TO ZOOM LOGIC ---
    const container = document.getElementById("ace-editor");
    
    container.addEventListener("touchstart", function(e) {
        if (e.touches.length === 2) {
            initialPinchDistance = Math.hypot(
                e.touches[0].pageX - e.touches[1].pageX,
                e.touches[0].pageY - e.touches[1].pageY
            );
            initialFontSize = parseInt(editor.getFontSize());
        }
    }, {passive: false});

    container.addEventListener("touchmove", function(e) {
        if (e.touches.length === 2 && initialPinchDistance) {
            e.preventDefault();
            const currentDistance = Math.hypot(
                e.touches[0].pageX - e.touches[1].pageX,
                e.touches[0].pageY - e.touches[1].pageY
            );
            const diff = currentDistance - initialPinchDistance;
            const newSize = initialFontSize + (diff / 10);
            if (newSize > 5 && newSize < 50) {
                editor.setFontSize(newSize + "pt");
            }
        }
    }, {passive: false});

    // --- UI HELPERS ---
    function goView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        lucide.createIcons();
    }

    function openModal(id) {
        document.getElementById(id).classList.add('show');
        const inp = document.getElementById(id).querySelector('input');
        if(inp && !inp.hidden) inp.focus();
    }
    
    function closeModal(id) {
        document.getElementById(id).classList.remove('show');
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // --- HOME & PROJECT LOGIC ---
    function renderProjects() {
        const list = document.getElementById('project-list-container');
        list.innerHTML = '';
        projects.forEach((p, idx) => {
            list.innerHTML += `
                <div class="p-card" onclick="openProject(${idx})">
                    <div class="p-icon"></div>
                    <div>
                        <h4 style="margin-bottom:4px;">${p.name}</h4>
                        <span style="font-size:12px; color:#999;">${p.date}</span>
                    </div>
                    <div class="p-menu-btn" onclick="openProjectMenu(event, ${idx})">
                        <i data-lucide="more-vertical" size="20"></i>
                    </div>
                </div>
            `;
        });
        lucide.createIcons();
    }

    function selectTemplate(el, type) {
        document.querySelectorAll('.temp-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        selectedTemplate = type;
    }

    function createProject() {
        const name = document.getElementById('new-p-name').value;
        if(!name) return;
        
        let files = {};
        if(selectedTemplate === 'php') {
            files = { 'index.php': '<?php echo "Hello World"; ?>', 'style.css': 'body { font-family: sans-serif; }' };
        } else {
            files = { 'index.html': '<h1>Hello World</h1>', 'style.css': 'body { background: #f0f0f0; }', 'script.js': 'console.log("Ready");' };
        }

        const newP = {
            name: name,
            date: new Date().toLocaleDateString(),
            files: files,
            fileMeta: {}, 
            config: {} 
        };
        projects.unshift(newP);
        saveData();
        renderProjects();
        closeModal('create-modal');
    }

    // --- PROJECT CONTEXT MENU ---
    function openProjectMenu(e, idx) {
        e.stopPropagation();
        menuIdx = idx;
        const p = projects[idx];
        document.getElementById('menu-project-title').innerText = p.name;
        openModal('project-options-modal');
    }

    function triggerProjectRename() {
        closeModal('project-options-modal');
        document.getElementById('rename-input').value = projects[menuIdx].name;
        openModal('rename-modal');
        window.renameType = 'project';
    }

    function triggerProjectDelete() {
        closeModal('project-options-modal');
        if(confirm('Are you sure you want to delete this website?')) {
            projects.splice(menuIdx, 1);
            saveData();
            renderProjects();
        }
    }

    async function triggerProjectExport() {
        closeModal('project-options-modal');
        const p = projects[menuIdx];
        const zip = new JSZip();
        
        Object.keys(p.files).forEach(name => {
            const content = p.files[name];
            if(content.startsWith('data:')) {
                zip.file(name, content.split(',')[1], {base64: true});
            } else {
                zip.file(name, content);
            }
        });

        try {
            const content = await zip.generateAsync({type:"blob"});
            const safeName = p.name.replace(/[^a-z0-9]/gi, '_');
            saveAs(content, safeName + ".zip");
            showToast('Saved to Download');
        } catch(e) {
            console.error(e);
            showToast('Export Failed');
        }
    }

    // --- DASHBOARD LOGIC ---
    function openProject(idx) {
        curProj = projects[idx];
        document.getElementById('dash-title').innerText = curProj.name;
        if(!curProj.fileMeta) curProj.fileMeta = {};
        
        // Restore Build Config
        if(curProj.buildConfig) {
           document.getElementById('cfg-appname').value = curProj.buildConfig.appName || curProj.name;
           document.getElementById('cfg-pkg').value = curProj.buildConfig.pkgName || "com.example.app";
           // Color Restore
           if(curProj.buildConfig.titleColor) {
               document.getElementById('cfg-color').value = curProj.buildConfig.titleColor;
               document.getElementById('col-disp').innerText = curProj.buildConfig.titleColor;
           }
        } else {
           document.getElementById('cfg-appname').value = curProj.name;
        }
        
        // Restore Icons
        if(curProj.config && curProj.config.icon) {
            document.getElementById('prev-icon').src = curProj.config.icon;
            document.getElementById('prev-icon').style.display = 'block';
        }
        currentPath = ""; 
        currentSearch = "";
        toggleSearch(false);
        renderFiles();
        goView('view-dashboard');
    }

    function saveData() {
        try {
            localStorage.setItem('hop_projects', JSON.stringify(projects));
        } catch(e) {
            alert("Storage limit reached!");
        }
    }

    // --- PHP SERVER LOGIC ---
    function initDatabase() {
        const icon = document.getElementById('db-icon');
        const title = document.getElementById('db-title');
        
        icon.setAttribute('data-lucide', 'loader');
        icon.classList.add('spinner'); 
        lucide.createIcons();
        title.innerText = "Initializing...";
        
        setTimeout(() => {
            icon.classList.remove('spinner');
            icon.setAttribute('data-lucide', 'check-circle');
            icon.setAttribute('color', 'green');
            lucide.createIcons();
            title.innerText = "Database Running";
            title.style.color = "green";
            showToast('Database Initialized');
        }, 1500);
    }

    // --- FILES & FOLDER LOGIC ---
    function renderFiles() {
        const list = document.getElementById('file-list-container');
        list.innerHTML = '';
        
        const allKeys = Object.keys(curProj.files);
        let items = [];
        
        allKeys.forEach(key => {
            if (key.startsWith(currentPath) && key !== currentPath) {
                const remaining = key.substring(currentPath.length);
                const parts = remaining.split('/');
                const name = parts[0];
                const isFolder = parts.length > 1; 
                
                if (!items.some(i => i.name === name)) {
                    const fullPath = currentPath + name + (isFolder ? '/' : '');
                    if(!curProj.fileMeta[fullPath]) {
                        curProj.fileMeta[fullPath] = {
                            date: new Date().toLocaleString(),
                            type: isFolder ? 'folder' : 'file'
                        };
                    }
                    items.push({
                        name: name,
                        path: fullPath,
                        type: isFolder ? 'folder' : 'file', 
                        meta: curProj.fileMeta[fullPath]
                    });
                }
            }
        });

        if(currentSearch) items = items.filter(i => i.name.toLowerCase().includes(currentSearch));

        items.sort((a, b) => {
            if (a.type === 'folder' && b.type !== 'folder') return -1;
            if (a.type !== 'folder' && b.type === 'folder') return 1;
            return a.name.localeCompare(b.name);
        });

        if (currentPath !== "") {
            list.innerHTML += `<div class="file-item file-item-back" onclick="goUp()"><div class="file-left"><div class="file-icon-box"><i data-lucide="arrow-left" color="#ef6c00"></i></div><div class="file-info"><div class="file-name" style="color:#ef6c00">..</div></div></div></div>`;
        }

        if(items.length === 0) { list.innerHTML += `<div style="text-align:center; padding:30px; color:#999;">Empty Folder</div>`; }

        items.forEach(item => {
            let icon = 'file'; let col = '#666'; let fill = 'none';
            if(item.type === 'folder' || (item.meta && item.meta.type === 'folder')) {
                icon = 'folder'; col = '#333'; fill = '#333'; 
            } else {
                if(item.name.endsWith('html')) { icon = 'file-code'; col = '#e91e63'; }
                else if(item.name.endsWith('css')) { icon = 'palette'; col = '#2196f3'; }
                else if(item.name.endsWith('js')) { icon = 'file-json'; col = '#ff9800'; }
                else if(item.name.endsWith('php')) { icon = 'server'; col = '#673ab7'; }
            }
            
            list.innerHTML += `
                <div class="file-item" onclick="clickItem('${item.path}', '${item.type}')">
                    <div class="file-left">
                        <div class="file-icon-box"><i data-lucide="${icon}" color="${col}" fill="${fill}" size="24"></i></div>
                        <div class="file-info">
                            <div class="file-name">${item.name}</div>
                            <div class="file-date">${item.meta ? item.meta.date : ''}</div>
                        </div>
                    </div>
                    <div class="file-menu" onclick="openFileMenu(event, '${item.path}')">
                        <i data-lucide="more-vertical" size="20"></i>
                    </div>
                </div>
            `;
        });
        lucide.createIcons();
    }

    function clickItem(path, type) {
        if(type === 'folder') {
            currentPath = path;
            renderFiles();
        } else {
            openFile(path);
        }
    }

    function goUp() {
        const parts = currentPath.split('/');
        parts.pop(); 
        parts.pop(); 
        currentPath = parts.length > 0 ? parts.join('/') + '/' : '';
        renderFiles();
    }

    // --- FILE CONTEXT MENU ---
    function openFileMenu(e, name) {
        e.stopPropagation();
        fileMenuName = name;
        document.getElementById('menu-file-title').innerText = name;
        openModal('file-options-modal');
    }

    function triggerFileRename() {
        closeModal('file-options-modal');
        document.getElementById('rename-input').value = fileMenuName.split('/').pop();
        openModal('rename-modal');
        window.renameType = 'file';
    }

    function triggerFileDelete() {
        closeModal('file-options-modal');
        delete curProj.files[fileMenuName];
        if(curProj.fileMeta[fileMenuName]) delete curProj.fileMeta[fileMenuName];
        saveData();
        renderFiles();
    }

    function confirmRename() {
        const val = document.getElementById('rename-input').value;
        if (!val) return;

        if (window.renameType === 'project') {
            projects[menuIdx].name = val;
            renderProjects();
        } else {
            const oldPath = fileMenuName;
            const pathParts = oldPath.split('/');
            pathParts.pop(); 
            if(pathParts.length > 0 && pathParts[pathParts.length-1] === '') pathParts.pop(); 
            const newPath = currentPath + val;

            const content = curProj.files[oldPath];
            const meta = curProj.fileMeta[oldPath];
            
            delete curProj.files[oldPath];
            delete curProj.fileMeta[oldPath];
            
            curProj.files[newPath] = content;
            curProj.fileMeta[newPath] = meta;
            
            renderFiles();
        }
        saveData();
        closeModal('rename-modal');
        showToast('Renamed Successfully');
    }

    // --- CREATE FILE UI ---
    function setFileType(ext) {
        const inp = document.getElementById('new-f-name');
        if(ext === '') { 
            inp.value = "New Folder"; 
        } else {
            inp.value = "New File" + ext; 
        }
        inp.focus();
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
    }

    function toggleSearch(show) {
        const n = document.getElementById('header-title-mode');
        const s = document.getElementById('header-search-mode');
        const i = document.getElementById('search-inp');
        if(show) { n.style.display='none'; s.style.display='flex'; s.classList.remove('hidden'); i.value=''; i.focus(); } 
        else { s.style.display='none'; n.style.display='flex'; currentSearch=""; renderFiles(); }
        lucide.createIcons();
    }
    
    function handleSearch() { currentSearch = document.getElementById('search-inp').value.toLowerCase(); renderFiles(); }
    
    function createFile() {
        const name = document.getElementById('new-f-name').value;
        if(name && curProj) {
            let isFolder = !name.includes('.');
            let fullPath = currentPath + name;
            if(isFolder) fullPath += '/';
            
            if(curProj.files[fullPath]) { showToast('File Exists'); return; }
            
            curProj.files[fullPath] = ""; 
            curProj.fileMeta[fullPath] = { 
                date: new Date().toISOString().replace('T', ' ').substring(0, 19), 
                type: isFolder ? 'folder' : 'file' 
            };
            
            saveData();
            renderFiles();
            closeModal('file-modal');
        }
    }

    // --- IMPORT & EDITOR ---
    function triggerImport(type) { closeModal('import-menu'); document.getElementById(type==='media'?'import-media':'import-any').click(); }
    function handleFileSelect(input, mode) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (e) => {
            const name = currentPath + f.name;
            curProj.files[name] = e.target.result;
            curProj.fileMeta[name] = { date: new Date().toLocaleString(), type: 'file' };
            saveData();
            renderFiles();
            showToast('Imported');
        };
        (mode === 'binary' || f.type.startsWith('image/')) ? r.readAsDataURL(f) : r.readAsText(f);
        input.value = '';
    }

    function openFile(name) {
        if(curProj.fileMeta[name] && curProj.fileMeta[name].type === 'folder') {
            currentPath = name;
            renderFiles();
            return;
        }
        
        curFile = name; document.getElementById('editor-fname').innerText = name.split('/').pop();
        const c = curProj.files[name], isImg = name.match(/\.(jpg|jpeg|png|gif|svg|webp)$/i);
        const ed = document.getElementById('ace-editor'), pd = document.getElementById('image-previewer');
        if(isImg && c.startsWith('data:image')) { ed.classList.add('hidden'); pd.classList.remove('hidden'); document.getElementById('img-prev-tag').src = c; }
        else { 
            pd.classList.add('hidden'); ed.classList.remove('hidden'); 
            let mode = 'html';
            if(name.endsWith('css')) mode = 'css';
            else if(name.endsWith('js')) mode = 'javascript';
            else if(name.endsWith('php')) mode = 'php';
            editor.session.setMode("ace/mode/" + mode); 
            editor.setValue(c, -1); 
        }
        
        const tabs = document.getElementById('tabs-container');
        tabs.innerHTML = `<div class="tab active" onclick="">${name.split('/').pop()}</div>`;
        goView('view-editor');
    }
    
    function saveFile() { if(curProj && curFile) { curProj.files[curFile] = editor.getValue(); saveData(); showToast('Saved'); } }
    function closeEditor() { saveFile(); goView('view-dashboard'); }
    
    // --- UPDATED RUN PROJECT (WITH ERUDA CONSOLE) ---
    function runProject() {
        saveFile(); 
        goView('view-preview'); 
        const frame = document.getElementById('preview-frame');
        
        // 1. Get the HTML content
        let code = curProj.files['index.html'] || curProj.files['index.php'];
        
        if(!code) {
             const anyHtml = Object.keys(curProj.files).find(k => k.endsWith('.html'));
             if(anyHtml) {
                 code = curProj.files[anyHtml];
                 showToast('Auto-launching ' + anyHtml);
             } else {
                 code = "<h2>No Index File Found</h2><p>Please create index.html</p>";
             }
        }
        
        // 2. Inject CSS/JS from virtual files
        Object.keys(curProj.files).forEach(f => {
            const fname = f.split('/').pop();
            // Replace Images
            if(fname.match(/\.(jpg|jpeg|png|gif|svg|webp)$/i)) {
                code = code.replace(new RegExp(fname, 'g'), curProj.files[f]);
            }
            // Inject CSS
            if(fname.endsWith('css')) {
                code += `<style>${curProj.files[f]}</style>`;
            }
            // Inject JS
            if(fname.endsWith('js')) {
                code += `<script>${curProj.files[f]}<\/script>`;
            }
        });

        // 3. INJECT ERUDA (The Real Console)
        const erudaScript = `
            <script src="//cdn.jsdelivr.net/npm/eruda"><\/script>
            <script>
                eruda.init({
                    tool: ['console', 'elements', 'network', 'resources', 'info'],
                    defaults: {
                        displaySize: 45,
                        transparency: 0.95,
                        theme: 'Monokai Pro'
                    }
                });
                console.log('%c HopWeb Console Ready ', 'background: #222; color: #bada55; font-size:16px;');
            <\/script>
        `;
        
        if(code.includes('</body>')) {
            code = code.replace('</body>', erudaScript + '</body>');
        } else {
            code += erudaScript;
        }

        // 4. Render
        frame.srcdoc = code;
    }

    // --- FULL SETTINGS LIST ---
    const toggleList = [
        {id:'full',lbl:'Fullscreen Mode'},
        {id:'notitle',lbl:'Hide Title Bar'},
        {id:'longpress',lbl:'Allow Long Press',on:true},
        {id:'loadui',lbl:'Show Loading UI',on:true},
        {id:'zoom',lbl:'Allow Zoom',on:true},
        {id:'pcmode',lbl:'PC Mode'},
        {id:'autoplay',lbl:'Allow Media Autoplay'},
        {id:'refresh',lbl:'Allow Swiping to Refresh',on:true},
        {id:'cam',lbl:'Allow Using Camera'},
        {id:'mic',lbl:'Allow Using Microphone'}
    ];

    function initSettingsUI() {
        const c = document.getElementById('toggles-container'); c.innerHTML='';
        toggleList.forEach(t => {
            c.innerHTML += `
            <div class="opt-row">
                <span class="opt-lbl">${t.lbl}</span>
                <label class="switch">
                    <input type="checkbox" id="cfg-${t.id}" ${t.on?'checked':''}>
                    <span class="slider"></span>
                </label>
            </div>`;
        });
    }

    let pickerMode = null; function pickImage(m) { pickerMode = m; document.getElementById('sys-img-picker').click(); }
    document.getElementById('sys-img-picker').onchange = function(e) {
        const f = e.target.files[0]; if(f) {
            const r = new FileReader(); r.onload = (e) => {
                const res = e.target.result;
                document.getElementById(pickerMode==='icon'?'prev-icon':'prev-splash').src = res;
                document.getElementById(pickerMode==='icon'?'prev-icon':'prev-splash').style.display='block';
                if(!curProj.config) curProj.config={}; curProj.config[pickerMode]=res; saveData();
            }; r.readAsDataURL(f);
        }
    };

    // --- IMPROVED BUILD & SHARE ---
    function startBuild() { openModal('modal-php-warn'); }
    function startRealProcess() {
        closeModal('modal-php-warn'); openModal('modal-loading');
        setTimeout(() => { closeModal('modal-loading'); openModal('modal-finish'); }, 2500);
    }
    
    async function triggerSystemShare() {
        closeModal('modal-finish');
        showToast('Preparing Package...');
        
        // 1. SAVE CONFIG FIRST
        if(!curProj.buildConfig) curProj.buildConfig = {};
        curProj.buildConfig.appName = document.getElementById('cfg-appname').value;
        curProj.buildConfig.pkgName = document.getElementById('cfg-pkg').value;
        curProj.buildConfig.titleColor = document.getElementById('cfg-color').value;
        saveData();

        // 2. GENERATE ZIP
        const zip = new JSZip();
        zip.file("hopweb_config.json", JSON.stringify(curProj.buildConfig, null, 2));
        
        Object.keys(curProj.files).forEach(n => {
            const c = curProj.files[n];
            if(!n.endsWith('/')) {
                if(c.startsWith('data:')) zip.file(n, c.split(',')[1], {base64:true});
                else zip.file(n, c);
            } else {
                zip.folder(n);
            }
        });

        // 3. SHARE / DOWNLOAD
        try {
            const content = await zip.generateAsync({type:"blob"});
            const safeName = (curProj.name || "project").replace(/[^a-z0-9]/gi, '_');
            const fileName = safeName + ".zip";
            const file = new File([content], fileName, { type: "application/zip" });
            
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({ files: [file], title: curProj.name, text: 'HopWeb Project: ' + curProj.name });
            } else {
                saveAs(content, fileName);
                showToast('Share not supported, Downloaded instead.');
            }
        } catch (err) { 
            console.error(err); 
            showToast('Error: ' + err.message); 
        }
    }
</script>
</body>
</html>
